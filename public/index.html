<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>weather</title>
    <style>
      body {
        margin: 0;
      }
      #date {
        position: fixed;
        top: 0;
        left: 0;
        background: #00000080;
        color: white;
        padding: 0.25em 0;
        border-radius: 0 0 0.25em 0;
        text-align: center;
        width: 32vmin;
        font: 5vmin/8vmin sans-serif;
        text-shadow: 1px 1px 1px #00000080;
      }
      canvas {
        display: block;
      }
    </style>
  </head>

  <body>
    <div id="date">Loadingâ€¦</div>
    <canvas id="weather" width="3400" height="1600"></canvas>
    <script>
      {
        const date = document.getElementById("date");
        const canvas = document.getElementById("weather");
        const ctx = canvas.getContext("2d");

        const evtSource = new EventSource("/manifest.php");
        evtSource.addEventListener("refresh", (event) => {
          const filenames = JSON.parse(event.data);
          const images = Array(filenames.length);

          filenames.forEach(async (filename, i) => {
            try {
              const response = await fetch(`/images/${filename}.gif`);
              const blob = await response.blob();
              const bitmap = await window.createImageBitmap(blob);

              images[i] = {
                bitmap,
                date: new Date(
                  response.headers.get("Last-Modified")
                ).toLocaleString(undefined, { timeStyle: "short" }),
              };
            } catch (error) {
              console.error(error);
            }
          });

          let index = -1;
          const render = () => {
            index = index === filenames.length - 1 ? 0 : index + 1;
            if (images[index] !== undefined) {
              date.innerText = images[index].date;
              ctx.drawImage(images[index].bitmap, 0, 0);
              ctx.fillStyle = "#c2eaf0";
              ctx.fillRect(40, 1350, 640, 150);
            }
          };

          render();

          window.setInterval(render, 200);
        });
      }
    </script>
  </body>
</html>
