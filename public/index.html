<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>weather.danrashid.com</title>
    <style>
      body {
        margin: 0;
        font-family: sans-serif;
      }
      .controls {
        position: fixed;
        bottom: 0;
        width: 100dvw;
        background: #00000080;
        color: white;
        display: flex;
        align-items: center;
        padding-bottom: 1rem;
      }
      #date {
        text-align: center;
        min-width: 6em;
        white-space: nowrap;
      }
      #slider {
        flex: 1;
        margin: 0 2rem 0 0;
        height: 4rem;
      }
      canvas {
        display: block;
      }
    </style>
  </head>

  <body>
    <div class="controls">
      <div id="date">Loadingâ€¦</div>
      <input id="slider" type="range" min="0" value="0" />
    </div>
    <canvas id="weather" width="3400" height="1600"></canvas>
    <script>
      {
        const dateEl = document.getElementById("date");
        const sliderEl = document.getElementById("slider");
        const canvasContext = document
          .getElementById("weather")
          .getContext("2d");

        const images = [];
        let intervalID = -1;
        let imageIndex = 0;

        const render = async () => {
          const image = images[imageIndex];
          sliderEl.value = imageIndex;

          if (image !== undefined) {
            const bitmap = await window.createImageBitmap(image.blob);

            dateEl.innerText = image.date;
            canvasContext.drawImage(bitmap, 0, 0);
            canvasContext.fillStyle = "#c2eaf0";
            canvasContext.fillRect(40, 1350, 640, 150);
          }

          imageIndex = imageIndex === images.length - 1 ? 0 : imageIndex + 1;
        };

        new EventSource("/manifest.php").addEventListener(
          "refresh",
          (event) => {
            const filenames = JSON.parse(event.data);
            images.length = filenames.length;
            sliderEl.max = filenames.length - 1;

            filenames.forEach(async (filename, index) => {
              try {
                const response = await fetch(`/images/${filename}.gif`);
                const blob = await response.blob();
                const date = new Date(
                  response.headers.get("Last-Modified")
                ).toLocaleString(undefined, { timeStyle: "short" });

                images[index] = {
                  blob,
                  date,
                };
              } catch (error) {
                console.error(error);
              }
            });

            window.clearInterval(intervalID);
            intervalID = window.setInterval(render, 200);
          }
        );

        if (window.location.hash) {
          const [x, y] = window.location.hash
            .replace(/^#/, "")
            .split(",")
            .map(Number);

          window.scrollTo(
            x - window.innerWidth / 2,
            y - window.innerHeight / 2
          );
        }

        let timeoutID = -1;
        window.addEventListener("scroll", (event) => {
          window.clearTimeout(timeoutID);
          timeoutID = window.setTimeout(() => {
            window.location.replace(
              `#${[
                window.innerWidth / 2 + window.scrollX,
                window.innerHeight / 2 + window.scrollY,
              ].map(Math.round)}`
            );
          }, 500);
        });

        sliderEl.addEventListener("input", (event) => {
          window.clearInterval(intervalID);
          imageIndex = Number(event.target.value);
          render();
        });

        sliderEl.addEventListener("change", (event) => {
          imageIndex = Number(event.target.value);
          render();
          window.setTimeout(() => {
            intervalID = window.setInterval(render, 200);
          }, 2000);
        });
      }
    </script>
  </body>
</html>
